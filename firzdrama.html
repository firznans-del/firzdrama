<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FirzDrama - Cinematic Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap');

        :root {
            --primary: #8b5cf6;
            --secondary: #fb2858;
            --bg-body: #020617;
            --bg-card: #0f172a;
            --bg-nav: rgba(15, 23, 42, 0.9);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --border: rgba(255, 255, 255, 0.06);
            --glass: rgba(255, 255, 255, 0.03);
            --danger: #ef4444;
            --success: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            overflow-x: hidden;
            transition: 0.3s;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        /* Navbar */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: var(--bg-nav);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 5%;
            z-index: 1000;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-container {
            position: relative;
            width: 300px;
            transition: 0.3s;
        }

        @media (max-width: 768px) {
            .navbar {
                height: 60px !important;
                padding: 0 15px !important;
            }

            .navbar .search-container {
                display: none !important;
                position: fixed;
                clip: rect(0, 0, 0, 0);
            }

            .logo {
                font-size: 1.3rem !important;
            }
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 20px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 50px;
            color: white;
            outline: none;
            transition: 0.3s;
        }

        .search-input:focus {
            border-color: var(--primary);
            width: 350px;
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dim);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-toggle {
            display: none;
        }

        @media (max-width: 768px) {
            .search-toggle {
                display: flex;
            }
        }

        /* Generic Components */
        .btn-glow {
            padding: 12px 24px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-glow:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(139, 92, 246, 0.4);
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--glass);
            border: 1px solid var(--border);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.3s;
        }

        .icon-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        /* Toasts/Notif */
        #toast-container {
            position: fixed;
            top: 90px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 15px 25px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            min-width: 250px;
            animation: slideIn 0.3s forwards;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .animate-fade {
            animation: fadeIn 0.6s ease-out;
        }

        .animate-slide {
            animation: slideIn 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* Profile Pill */
        .profile-pill {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 5px 5px 5px 15px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 50px;
            cursor: pointer;
            transition: 0.3s;
        }

        .profile-pill:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            object-fit: cover;
        }

        /* Main Container */
        .main-wrapper {
            max-width: 1440px;
            margin: 0 auto;
            padding: 100px 5% 50px;
        }

        @media (max-width: 768px) {
            .main-wrapper {
                padding: 110px 12px 30px !important;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Drama Cards */
        .banner-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .banner-title span {
            width: 50px;
            height: 6px;
            background: var(--primary);
            border-radius: 3px;
        }

        .drama-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .drama-card {
            background: var(--bg-card);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .drama-card:hover {
            transform: translateY(-10px);
            border-color: var(--primary);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .img-container {
            aspect-ratio: 2/3;
            overflow: hidden;
            position: relative;
        }

        .img-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: 0.6s;
        }

        .drama-card:hover .img-container img {
            transform: scale(1.1);
            filter: brightness(0.6);
        }

        .card-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 3px 10px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.65rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 2;
        }

        .card-info {
            padding: 12px 15px;
        }

        .card-info h3 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-info p {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        /* Video Player */
        .video-overlay {
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 32px;
            overflow: hidden;
            border: 2px solid var(--border);
            margin-bottom: 40px;
        }

        video {
            width: 100%;
            height: 100%;
        }

        /* Tabs */
        .tab-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 40px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 12px 25px;
            border-radius: 12px;
            background: var(--glass);
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tab-btn:hover {
            color: white;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: transparent;
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
        }

        /* Modals & Dialogs */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-body {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 32px;
            width: 100%;
            max-width: 500px;
            padding: 40px;
            position: relative;
            animation: zoomIn 0.3s;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-dim);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .input {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 16px;
            color: white;
            outline: none;
            transition: 0.3s;
        }

        .input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.2);
        }

        /* User Management */
        .admin-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        .admin-table th {
            text-align: left;
            padding: 15px;
            color: var(--text-dim);
        }

        .admin-table td {
            background: var(--glass);
            padding: 20px;
            border: 1px solid var(--border);
        }

        .admin-table tr td:first-child {
            border-radius: 16px 0 0 16px;
            border-right: none;
        }

        .admin-table tr td:last-child {
            border-radius: 0 16px 16px 0;
            border-left: none;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .status-deleted {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            text-decoration: line-through;
        }

        /* Login */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at top, #1e1b4b, #020617);
        }

        .login-card {
            background: var(--bg-card);
            padding: 50px;
            border-radius: 32px;
            border: 1px solid var(--border);
            width: 450px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        /* Profile */
        .profile-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 40px;
        }

        .profile-side {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 32px;
            padding: 40px;
            text-align: center;
            height: fit-content;
        }

        .avatar-edit {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 0 auto 30px;
        }

        .avatar-edit img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 6px solid var(--primary);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
        }

        .cam-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 45px;
            height: 45px;
            background: var(--secondary);
            color: white;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .back-home {
            margin-bottom: 30px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            font-weight: 700;
            cursor: pointer;
        }

        .back-home:hover {
            opacity: 0.8;
        }

        /* Chat System Styles */
        #chatWidget {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 2000;
        }

        .chat-bubble {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
            transition: 0.3s;
        }

        .chat-bubble:hover {
            transform: scale(1.1);
        }

        .chat-user-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
        }

        .chat-user-item:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: var(--border);
        }

        .chat-user-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }

        .chat-box {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            height: 450px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            display: none;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s forwards;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .chat-header {
            padding: 15px 20px;
            background: var(--glass);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .msg {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .msg.sent {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .msg.received {
            align-self: flex-start;
            background: var(--glass);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        /* Modern History Styles */
        .history-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: scale(1.02);
            border-color: var(--primary);
        }

        .hist-thumb-wrapper {
            width: 100px;
            height: 60px;
            border-radius: 12px;
            overflow: hidden;
            flex-shrink: 0;
            border: 1px solid var(--border);
        }

        .hist-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: 0.5s;
        }

        .history-item:hover .hist-thumb {
            transform: scale(1.1);
        }

        .hist-details {
            flex: 1;
            min-width: 0;
        }

        .hist-details b {
            display: block;
            font-size: 0.95rem;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .hist-details small {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        .hist-play-icon {
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: white;
            opacity: 0;
            transform: translateX(20px);
            transition: 0.3s;
        }

        .history-item:hover .hist-play-icon {
            opacity: 1;
            transform: translateX(0);
        }

        /* Episode Styling */
        .ep-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .ep-btn {
            padding: 12px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            text-align: center;
            font-size: 0.9rem;
        }

        .ep-btn:hover {
            background: var(--primary);
            border-color: transparent;
            transform: translateY(-2px);
        }

        .ep-btn.active {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-color: transparent;
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }

        /* Mobile Responsiveness */
        @media (max-width: 992px) {
            .profile-container {
                grid-template-columns: 1fr;
            }

            .detail-layout {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 0 12px;
                height: 60px;
            }

            .logo {
                font-size: 1.4rem;
            }

            .banner-title {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }

            .drama-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .drama-card {
                border-radius: 12px;
            }

            .card-badge {
                top: 8px;
                left: 8px;
                padding: 3px 8px;
                font-size: 0.6rem;
            }

            .card-info {
                padding: 6px 8px;
            }

            .card-info h3 {
                font-size: 0.85rem;
                margin-bottom: 3px;
            }

            .card-info p {
                font-size: 0.6rem;
            }

            .video-overlay {
                border-radius: 16px;
                margin-bottom: 15px;
            }

            #detTitle {
                font-size: 1.3rem !important;
            }

            .tab-btn {
                padding: 6px 12px;
                font-size: 0.75rem;
                border-radius: 8px;
            }
        }

        @media (max-width: 480px) {
            .navbar {
                height: 60px;
            }

            .logo {
                font-size: 1.2rem;
            }

            .main-wrapper {
                padding-top: 85px !important;
            }

            .drama-grid {
                gap: 10px;
            }

            .card-info h3 {
                font-size: 0.8rem;
            }

            .tab-bar {
                margin-bottom: 20px;
            }
        }

        /* Detail Adjustments */
        .video-overlay {
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        #detTitle {
            font-size: 2rem;
            font-weight: 800;
        }

        @media (max-width: 768px) {
            .video-overlay {
                border-radius: 12px;
                margin-bottom: 15px;
            }

            #detTitle {
                font-size: 1.4rem !important;
            }
        }

        .tab-bar {
            gap: 8px;
            margin-bottom: 25px;
        }

        .tab-btn {
            padding: 8px 15px;
            font-size: 0.85rem;
        }
        }

        .chat-footer {
            padding: 15px;
            display: flex;
            gap: 10px;
            border-top: 1px solid var(--border);
        }

        /* Admin Dashboard Styles */
        .dash-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .dash-card {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 24px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .dash-card h2 {
            font-size: 2.5rem;
            color: var(--primary);
        }

        .dash-card p {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-top: 10px;
            font-weight: 600;
        }

        .activity-log {
            background: var(--bg-card);
            border-radius: 24px;
            border: 1px solid var(--border);
            padding: 30px;
        }

        .log-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.9rem;
        }

        .log-meta {
            display: flex;
            gap: 10px;
            font-size: 0.75rem;
            opacity: 0.6;
        }

        .log-badge {
            background: var(--border);
            padding: 2px 8px;
            border-radius: 6px;
        }

        .log-user {
            color: var(--primary);
            font-weight: 700;
        }

        .log-time {
            color: var(--text-dim);
            min-width: 80px;
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .log-time {
            color: var(--text-dim);
            min-width: 80px;
        }

        .log-user {
            font-weight: 700;
            color: var(--primary);
        }

        /* Welcome Animation */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(20px);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: 1s cubic-bezier(0.19, 1, 0.22, 1);
        }

        .welcome-content {
            text-align: center;
            opacity: 0;
            transform: translateY(30px);
            animation: welcomePop 1s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes welcomePop {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-glow {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(to right, var(--primary), var(--secondary), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
            margin-bottom: 20px;
        }

        .welcome-sub {
            color: var(--text-dim);
            font-size: 1.2rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        @media (max-width: 768px) {
            .welcome-glow {
                font-size: 1.8rem;
            }

            .welcome-sub {
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>

    <div id="toast-container"></div>

    <!-- Welcome Overlay -->
    <div id="welcomeOverlay" class="welcome-overlay hidden">
        <div class="welcome-content">
            <div class="logo" style="justify-content:center; font-size: 3.5rem; margin-bottom: 10px;">
                <i class="fas fa-play-circle" style="color:var(--primary);"></i>
            </div>
            <h1 class="welcome-glow">Selamat Datang</h1>
            <p id="welcomeUser" class="welcome-sub" style="color:#fff; font-weight:800; margin-bottom: 5px;"></p>
            <p class="welcome-sub">di FirzDrama Premium</p>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="logo" style="justify-content:center; margin-bottom: 2rem;">
                <i class="fas fa-play-circle"></i> FirzDrama
            </div>
            <h2 style="margin-bottom:10px;">Masuk FirzDrama</h2>
            <p style="color:var(--text-dim); margin-bottom:40px;">Nikmati sensasi drama premium tanpa batas.</p>
            <form id="loginForm">
                <div class="form-group" style="text-align:left;">
                    <label class="label">Username</label>
                    <input type="text" id="username" class="input" placeholder="Masukkan username" required>
                </div>
                <div class="form-group" style="text-align:left;">
                    <label class="label">Password</label>
                    <div style="position:relative;">
                        <input type="password" id="password" class="input" placeholder="Masukkan password" required>
                        <i class="fas fa-eye"
                            style="position:absolute; right:20px; top:50%; transform:translateY(-50%); cursor:pointer; color:var(--text-dim);"
                            onclick="togglePass('password', this)"></i>
                    </div>
                </div>
                <button type="submit" class="btn-glow" style="width:100%;">Masuk Akun</button>
                <p style="margin-top:25px; color:var(--text-dim); font-size:0.9rem;">
                    Belum punya akun? <a href="#" onclick="showRegister()"
                        style="color:var(--primary); font-weight:700; text-decoration:none;">Daftar Sekarang</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Chat Widget -->
    <div id="chatWidget" class="hidden">
        <div id="chatBox" class="chat-box">
            <div class="chat-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-headset" style="color:var(--primary);"></i>
                    <b>Bantuan Admin</b>
                </div>
                <i class="fas fa-times" onclick="toggleChat()" style="cursor:pointer;"></i>
            </div>
            <div id="chatBody" class="chat-body"></div>
            <div class="chat-footer">
                <input type="text" id="chatInput" placeholder="Ketik pesan..." class="input" style="padding:10px 15px;">
                <button class="icon-btn" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <div class="chat-bubble" onclick="toggleChat()">
            <i class="fas fa-comment-dots"></i>
            <div id="chatBadge"
                style="position:absolute; top:0; right:0; background:var(--danger); width:15px; height:15px; border-radius:50%; display:none;">
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainApp" class="hidden">
        <nav class="navbar">
            <div class="nav-left">
                <div class="logo" onclick="goHome()"><i class="fas fa-play-circle"></i> FirzDrama</div>
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="Cari drama favorit...">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            <div class="nav-right">
                <div class="icon-btn" onclick="goHome()"><i class="fas fa-home"></i></div>
                <div class="profile-pill" onclick="showSection('profile')" style="padding: 5px 10px;">
                    <span id="navName"
                        style="max-width:80px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Firman</span>
                    <img id="navAvatar" src="" class="avatar-small">
                </div>
                <div class="icon-btn" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i></div>
            </div>
        </nav>

        <div class="main-wrapper">
            <!-- Mobile Search Bar (Optional, only shows on mobile if you want it there instead) -->
            <div id="mobileSearch" class="search-container" style="width:100%; margin-bottom:20px; display:none;">
                <input type="text" id="searchInputMobile" class="search-input" placeholder="Cari drama..."
                    style="width:100%;">
                <i class="fas fa-search search-icon"></i>
            </div>

            <!-- Home Section -->
            <div id="homeSection">
                <div class="tab-bar">
                    <button class="tab-btn active" onclick="loadContent('trending', this)"><i class="fas fa-fire"></i>
                        Trending</button>
                    <button class="tab-btn" onclick="loadContent('latest', this)"><i class="fas fa-clock"></i>
                        Terbaru</button>
                    <button class="tab-btn" onclick="loadContent('foryou', this)"><i class="fas fa-gem"></i> Untuk
                        Kamu</button>
                    <button class="tab-btn" onclick="loadContent('vip', this)"><i class="fas fa-crown"></i>
                        VIP</button>
                    <button class="tab-btn" onclick="loadContent('dubindo', this)"><i class="fas fa-microphone"></i>
                        Dub
                        Indo</button>
                    <button class="tab-btn" onclick="showWatchlist(this)"><i class="fas fa-bookmark"></i>
                        Playlist</button>
                    <button id="adminTab" class="tab-btn hidden" onclick="showAdmin(this)"><i
                            class="fas fa-user-shield"></i> Admin</button>
                </div>

                <h1 class="banner-title" id="homeTitle"><span></span> Trending Now</h1>
                <div id="dramaGrid" class="drama-grid"></div>
                <div id="loadMoreCont" style="display:flex; justify-content:center; margin-top:50px;">
                    <button class="btn-glow" id="loadMoreBtn" onclick="loadMore()" style="display:none;">Muat Lebih
                        Banyak...</button>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profileSection" class="hidden">
                <div class="back-home" onclick="goHome()"><i class="fas fa-arrow-left"></i> Kembali ke Beranda</div>
                <div class="profile-container">
                    <div class="profile-side">
                        <div class="avatar-edit">
                            <img id="profImg" src="">
                            <label for="fileIn" class="cam-btn"><i class="fas fa-camera"></i></label>
                            <input type="file" id="fileIn" class="hidden" accept="image/*"
                                onchange="uploadAvatar(this)">
                        </div>
                        <h2 id="profLabelName">Firman</h2>
                        <p id="profLabelRole" style="color:var(--primary); font-weight:700; margin-top:5px;">ADMIN
                        </p>
                    </div>
                    <div>
                        <div class="modal-body" style="animation:none; max-width:100%; width:100%; margin-bottom:30px;">
                            <h3 style="margin-bottom:20px;"><i class="fas fa-id-card"></i> Ganti Nama</h3>
                            <div class="form-group"><input type="text" id="editFullname" class="input"></div>
                            <button class="btn-glow" onclick="saveProfileName()">Update Nama</button>
                        </div>
                        <div class="modal-body" style="animation:none; max-width:100%; width:100%; margin-bottom:30px;">
                            <h3 style="margin-bottom:20px;"><i class="fas fa-lock"></i> Keamanan Akun</h3>
                            <div class="form-group"><label class="label">Password Sekarang</label>
                                <div style="position:relative;"><input type="password" id="curP" class="input"><i
                                        class="fas fa-eye"
                                        style="position:absolute; right:20px; top:50%; transform:translateY(-50%); cursor:pointer;"
                                        onclick="togglePass('curP', this)"></i></div>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:25px;">
                                <div><label class="label">Password Baru</label><input type="password" id="newP"
                                        class="input"></div>
                                <div><label class="label">Konfirmasi Password Baru</label><input type="password"
                                        id="confP" class="input"></div>
                            </div>
                            <button class="btn-glow" onclick="handleUpdatePass()">Ganti Password</button>
                        </div>
                        <div class="modal-body" style="animation:none; max-width:100%; width:100%;">
                            <h3 style="margin-bottom:20px;"><i class="fas fa-history"></i> Riwayat Menonton</h3>
                            <div id="historyList" style="display:flex; flex-direction:column; gap:15px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detail Section -->
            <div id="detailSection" class="hidden">
                <div class="back-home" onclick="goHome()"><i class="fas fa-arrow-left"></i> Kembali</div>
                <div class="video-overlay"><video id="mainVideo" controls playsinline></video></div>
                <div class="detail-layout" style="display:grid; grid-template-columns:2fr 1fr; gap:40px;">
                    <div>
                        <h1 id="detTitle"
                            style="font-size:2.5rem; margin-bottom:15px; background:linear-gradient(to right, #fff, var(--text-dim)); background-clip:text; -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
                            Drama Name</h1>
                        <p id="detDesc"
                            style="color:var(--text-dim); line-height:1.6; font-size:1.1rem; margin-bottom:20px;"></p>

                        <div id="detActions" style="display:flex; gap:12px; margin-bottom:30px;">
                            <!-- Dynamic Button will be injected here -->
                        </div>
                    </div>
                    <div class="modal-body" style="animation:none; max-width:100%; width:100%; height:fit-content;">
                        <h3 style="display:flex; justify-content:space-between; align-items:center;">
                            <span>Pilih Episode</span>
                            <span id="epCount" style="font-size:0.8rem; opacity:0.5;">0 Episodes</span>
                        </h3>
                        <div id="epGrid" class="ep-grid"></div>
                    </div>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="hidden">
                <div class="back-home" onclick="goHome()"><i class="fas fa-arrow-left"></i> Kembali ke Beranda</div>

                <div class="tab-bar">
                    <button class="tab-btn active" onclick="setAdminTab('dash', this)"><i class="fas fa-chart-pie"></i>
                        Dashboard</button>
                    <button class="tab-btn" onclick="setAdminTab('users', this)"><i class="fas fa-users"></i>
                        Pengguna</button>
                    <button class="tab-btn" onclick="setAdminTab('chats', this)"><i class="fas fa-comments"></i>
                        Chat
                        Masuk</button>
                </div>

                <!-- Dashboard Section -->
                <div id="adminDash">
                    <div class="dash-grid">
                        <div class="dash-card">
                            <h2 id="st_users">0</h2>
                            <p>TOTAL PENGGUNA</p>
                        </div>
                        <div class="dash-card">
                            <h2 id="st_chats">0</h2>
                            <p>CHAT AKTIF</p>
                        </div>
                        <div class="dash-card">
                            <h2 id="st_dramas">0</h2>
                            <p>KOLEKSI DRAMA</p>
                        </div>
                        <div class="dash-card">
                            <h2 id="st_active" style="color:var(--success);">0</h2>
                            <p>PENGGUNA AKTIF</p>
                        </div>
                    </div>
                    <div class="activity-log">
                        <h3 style="margin-bottom:20px;"><i class="fas fa-stream"></i> Real-time Activity Log</h3>
                        <div id="logBody"></div>
                    </div>
                </div>

                <!-- User Management Section -->
                <div id="adminUsers" class="hidden">
                    <div class="banner-title"><span></span> User Management</div>
                    <div style="display:flex; justify-content:flex-end; margin-bottom:20px;"><button class="btn-glow"
                            onclick="openAdminModal()">+ Tambah User</button></div>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Nama / Avatar</th>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody"></tbody>
                    </table>
                </div>

                <!-- Admin Chat Section -->
                <div id="adminChats" class="hidden"
                    style="display:grid; grid-template-columns:300px 1fr; gap:20px; height:500px;">
                    <div style="border:1px solid var(--border); border-radius:24px; overflow-y:auto; padding:20px;"
                        id="adminUserList"></div>
                    <div style="border:1px solid var(--border); border-radius:24px; display:flex; flex-direction:column;"
                        id="adminChatArea">
                        <div id="adminChatBody" class="chat-body"></div>
                        <div class="chat-footer" id="adminChatFooter" style="display:none;">
                            <input type="text" id="adminChatIn" class="input" placeholder="Balas user...">
                            <button class="icon-btn" onclick="replyChat()"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-body" style="text-align:center;">
            <h2 id="confirmTitle">Konfirmasi</h2>
            <p id="confirmMsg" style="color:var(--text-dim); margin-top:15px;"></p>
            <div style="display:flex; gap:15px; justify-content:center; margin-top:30px;">
                <button class="btn-glow" id="btnYes">Ya, Lanjutkan</button>
                <button class="icon-btn" onclick="closeConfirmModal()"
                    style="width:auto; padding:0 30px;">Batal</button>
            </div>
        </div>
    </div>

    <div id="registerModal" class="modal-overlay">
        <div class="modal-body">
            <h2 style="margin-bottom:10px;">Daftar Akun Baru</h2>
            <p style="color:var(--text-dim); margin-bottom:30px;">Daftar sekarang untuk akses penuh ke FirzDrama.
            </p>
            <form id="regForm">
                <div class="form-group">
                    <label class="label">Nama Lengkap</label>
                    <input type="text" id="regName" class="input" placeholder="Masukkan nama" required>
                </div>
                <div class="form-group">
                    <label class="label">Username</label>
                    <input type="text" id="regU" class="input" placeholder="Buat username" required>
                </div>
                <div class="form-group">
                    <label class="label">Password</label>
                    <input type="password" id="regP" class="input" placeholder="Buat password" required>
                </div>
                <div style="display:flex; gap:15px; margin-top:30px;">
                    <button type="submit" class="btn-glow">Daftar & Masuk</button>
                    <button type="button" class="icon-btn" onclick="closeRegister()"
                        style="width:auto; padding:0 30px;">Batal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Management Modal -->
    <div id="adminModal" class="modal-overlay">
        <div class="modal-body">
            <h2 id="admModalTitle" style="margin-bottom:25px;">Tambah User</h2>
            <div class="form-group"><label class="label">Nama Lengkap</label><input type="text" id="am_name"
                    class="input"></div>
            <div class="form-group"><label class="label">Username</label><input type="text" id="am_u" class="input">
            </div>
            <div class="form-group"><label class="label">Password</label><input type="password" id="am_p" class="input">
            </div>
            <div class="form-group"><label class="label">Role</label><select id="am_r" class="input"
                    style="background:var(--bg-body);">
                    <option value="user">USER</option>
                    <option value="admin">ADMIN</option>
                </select></div>
            <div style="display:flex; gap:15px; margin-top:30px;">
                <button class="btn-glow" onclick="handleSaveAdmin()">Simpan</button>
                <button class="icon-btn" onclick="closeAdminModal()" style="width:auto; padding:0 30px;">Batal</button>
            </div>
        </div>
    </div>

    <!-- Download Options Modal -->
    <div id="downloadModal" class="modal-overlay">
        <div class="modal-body" style="max-width:400px; text-align:center;">
            <i class="fas fa-download fa-3x" style="color:var(--primary); margin-bottom:20px;"></i>
            <h2 id="dlModalTitle" style="margin-bottom:10px;">Download Drama</h2>
            <p style="color:var(--text-dim); margin-bottom:30px;">Pilih metode download yang kamu inginkan:</p>

            <div style="display:flex; flex-direction:column; gap:12px;">
                <button class="btn-glow" id="dlCurrentBtn">
                    <i class="fas fa-play-circle"></i> Download Episode Ini
                </button>
                <button class="tab-btn" id="dlAllBtn"
                    style="background:rgba(16, 185, 129, 0.1); color:var(--success); border-color:var(--success);">
                    <i class="fas fa-layer-group"></i> Download Semua Episode
                </button>
                <button class="icon-btn" onclick="closeDownloadModal()"
                    style="width:100%; border:none; margin-top:10px;">Batal</button>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://api.sansekai.my.id/api';
        let users = []; let current = null; let wl = []; let hist = []; let hlsObj = null;
        let editUid = null; let allDramas = [];
        let chats = []; let activeChatUser = null;
        let logs = []; let playerIP = '0.0.0.0';
        let playlists_db = {}; // Device-agnostic playlists {uid: [dramas]}
        let history_db = {};   // Device-agnostic history {uid: [dramas]}
        const objStore = { d: {}, e: {} }; // Safe storage for UI references

        function getSafeId(obj) { return obj.bookId || obj.id || obj.bookID || Math.random().toString(36).substr(2, 9); }

        async function fetchIP() {
            try {
                // Try multiple providers for better WIFI/Data detection
                const r = await fetch('https://api.ipify.org?format=json');
                const d = await r.json();
                playerIP = d.ip;
            } catch (e) {
                try {
                    const r2 = await fetch('https://ipapi.co/json/');
                    const d2 = await r2.json();
                    playerIP = d2.ip;
                } catch (e2) { playerIP = 'Local IP'; }
            }
        }

        async function init() {
            await fetchIP();
            try {
                const res = await fetch('/api/load-all');
                const cloudData = await res.json();
                users = cloudData.users || [];
                chats = cloudData.chats || [];
                logs = cloudData.logs || [];
                playlists_db = cloudData.playlists || {};
                history_db = cloudData.history || {};

                if (users.length === 0) {
                    const saved = localStorage.getItem('firz_pro_users');
                    if (saved) { users = JSON.parse(saved); serverSync('users', users); }
                    else { users = [{ id: '1', username: 'Nandafirman', password: 'nanda123', name: 'Nanda Firman', role: 'admin', avatar: '', status: 'active' }]; syncUsers(); }
                }
            } catch (e) {
                console.error('Offline mode', e);
                users = JSON.parse(localStorage.getItem('firz_pro_users') || '[]');
                chats = JSON.parse(localStorage.getItem('firz_pro_chats') || '[]');
                logs = JSON.parse(localStorage.getItem('firz_pro_logs') || '[]');
            }

            const session = localStorage.getItem('firz_pro_session');
            if (session) {
                try {
                    const s = JSON.parse(session);
                    current = users.find(u => u.id === s.id && u.status === 'active');
                    if (current) {
                        wl = playlists_db[current.id] || [];
                        hist = history_db[current.id] || [];
                        showApp();
                        logActivity('Session resumed');
                    } else localStorage.removeItem('firz_pro_session');
                } catch (e) { localStorage.removeItem('firz_pro_session'); }
            }
            setInterval(syncRealtimeData, 5000);
        }

        function serverSync(type, data) {
            fetch(`/api/sync-${type}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).catch(e => console.warn(`Sync failed for ${type}`, e));
        }

        function syncUsers() { localStorage.setItem('firz_pro_users', JSON.stringify(users)); serverSync('users', users); }
        function saveChats() { localStorage.setItem('firz_pro_chats', JSON.stringify(chats)); serverSync('chats', chats); }
        function syncPersonalData() {
            if (!current) return;
            playlists_db[current.id] = wl;
            history_db[current.id] = hist;
            serverSync('playlists', playlists_db);
            serverSync('history', history_db);
        }

        function logActivity(act, userOverride = null) {
            const entry = {
                t: Date.now(),
                u: userOverride || (current ? current.name : 'Unknown User'),
                a: act,
                ip: playerIP,
                ua: navigator.userAgent
            };
            logs.unshift(entry);
            if (logs.length > 50) logs.pop();
            localStorage.setItem('firz_pro_logs', JSON.stringify(logs));
            serverSync('logs', logs); // Push to central DB
            renderLogs();
        }

        function renderLogs() {
            const lb = document.getElementById('logBody');
            if (!lb) return;
            lb.innerHTML = logs.map(l => {
                let deviceIcon = 'fa-laptop';
                let deviceName = 'Desktop';
                if (l.ua) {
                    if (l.ua.includes('iPhone')) { deviceIcon = 'fa-mobile-alt'; deviceName = 'iPhone'; }
                    else if (l.ua.includes('Android')) { deviceIcon = 'fa-mobile-alt'; deviceName = 'Android'; }
                    else if (l.ua.includes('Mobi')) { deviceIcon = 'fa-mobile-alt'; deviceName = 'Mobile'; }
                }

                const isFailed = l.a && l.a.includes('failed');
                const isAuth = l.a && (l.a.includes('Login') || l.a.includes('Session'));

                return `
                <div class="log-item animate-slide" style="border-left: 4px solid ${isFailed ? 'var(--danger)' : (isAuth ? 'var(--primary)' : 'var(--success)')};">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                        <div>
                            <span class="log-user" style="color:var(--primary); font-weight:800;">@${l.u.replace(/\s/g, '')}</span> 
                            <span style="font-size:0.85rem; opacity:0.9;">${l.a}</span>
                        </div>
                        <span style="font-size:0.7rem; opacity:0.5; white-space:nowrap;">${new Date(l.t).toLocaleTimeString()}</span>
                    </div>
                    <div style="display:flex; flex-wrap:wrap; gap:8px;">
                        <span class="log-badge" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); font-size:0.65rem; padding:2px 8px; border-radius:50px; display:flex; align-items:center; gap:5px;">
                            <i class="fas fa-network-wired" style="font-size:0.6rem; color:var(--success);"></i> ${l.ip || '0.0.0.0'}
                        </span>
                        <span class="log-badge" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); font-size:0.65rem; padding:2px 8px; border-radius:50px; display:flex; align-items:center; gap:5px;">
                            <i class="fas ${deviceIcon}" style="font-size:0.6rem; color:var(--primary);"></i> ${deviceName}
                        </span>
                    </div>
                </div>
            `;
            }).join('');
        }

        function showToast(msg, type = 'success') {
            const cont = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> <span>${msg}</span>`;
            cont.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        function togglePass(id, icon) {
            const el = document.getElementById(id);
            el.type = el.type === 'password' ? 'text' : 'password';
            icon.classList.toggle('fa-eye-slash');
        }

        function triggerWelcome() {
            const ov = document.getElementById('welcomeOverlay');
            const userText = document.getElementById('welcomeUser');
            if (!ov || !userText) return;

            userText.innerText = current ? current.name : 'Sahabat Firz';
            ov.classList.remove('hidden');
            ov.style.opacity = '1';

            setTimeout(() => {
                ov.style.opacity = '0';
                ov.style.pointerEvents = 'none';
                setTimeout(() => ov.classList.add('hidden'), 1000);
            }, 2500);
        }

        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value, p = document.getElementById('password').value;
            const found = users.find(user => user.username === u && user.password === p && user.status === 'active');
            if (found) {
                current = found;
                localStorage.setItem('firz_pro_session', JSON.stringify(found));
                showApp();
                logActivity('Logged in');
                showToast('Login Berhasil!');
            }
            else {
                logActivity(`Gagal Login! Password yg dicoba: "${p}"`, u || 'Unknown');
                showToast('Username atau Password salah!', 'error');
            }
        };

        function showApp() {
            try {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                // Show chat widget only for non-admins
                if (current && current.role !== 'admin') {
                    document.getElementById('chatWidget').classList.remove('hidden');
                } else {
                    document.getElementById('chatWidget').classList.add('hidden');
                }

                if (current && current.role === 'admin') {
                    document.getElementById('adminTab').classList.remove('hidden');
                }

                updateUI();
                triggerWelcome();

                // Multi-device playlist/history sync
                wl = playlists_db[current.id] || [];
                hist = history_db[current.id] || [];

                loadContent('trending');
                renderChat();
            } catch (e) {
                console.error('App load error', e);
                // Fallback: show login if everything fails
                document.getElementById('loginPage').classList.remove('hidden');
            }
        }

        function updateUI() {
            document.getElementById('navName').innerText = current.name;
            const av = document.getElementById('navAvatar'); const pav = document.getElementById('profImg');
            const img = getAvatar(current);
            av.src = img; pav.src = img;
        }

        function goHome() {
            showSection('home');
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                if (activeTab.innerText.includes('Playlist')) showWatchlist(activeTab);
                else loadContent('trending', activeTab);
            }
        }

        function showSection(id) {
            ['homeSection', 'profileSection', 'detailSection', 'adminView'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id === 'admin' ? 'adminView' : id + 'Section').classList.remove('hidden');
            if (id === 'profile') renderProfileData();
            if (id === 'home') stopVideo();
        }

        function stopVideo() { const v = document.getElementById('mainVideo'); v.pause(); v.src = ''; if (hlsObj) hlsObj.destroy(); }

        let currentPage = 1;
        let currentCat = 'trending';

        async function loadContent(cat, el, append = false) {
            if (el) {
                document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
            }

            const grid = document.getElementById('dramaGrid');
            const btn = document.getElementById('loadMoreBtn');
            const titleEl = document.getElementById('homeTitle');

            if (!append) {
                currentPage = 1;
                currentCat = cat;
                allDramas = []; // Reset list
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 50px;"><i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>Memuat Koleksi Drama...</div>';
                btn.style.display = 'none';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                currentPage++;
            }

            const displayName = cat === 'dubindo' ? 'Dubbing Indonesia' : cat.charAt(0).toUpperCase() + cat.slice(1);
            titleEl.innerHTML = `<span></span> ${displayName}`;
            showSection('home');

            try {
                let fetchedData = [];

                // Handle categories with careful endpoint logic
                if (cat === 'trending' || cat === 'latest' || cat === 'foryou') {
                    const usePage = (cat === 'foryou' || append);
                    const ep = append ? 'foryou' : cat;
                    const url = `${API}/dramabox/${ep}${usePage ? `?page=${currentPage}` : ''}`;

                    const res = await fetch(url);
                    const rawData = await res.json();
                    fetchedData = Array.isArray(rawData) ? rawData : (rawData.data || []);

                    // Massive Merge for Home/Trending Page 1 to ensure it's NEVER empty
                    if (cat === 'trending' && !append) {
                        try {
                            const [resL, resV, resF] = await Promise.all([
                                fetch(`${API}/dramabox/latest`),
                                fetch(`${API}/dramabox/vip`),
                                fetch(`${API}/dramabox/foryou`)
                            ]);
                            const [dataL, dataV, dataF] = await Promise.all([resL.json(), resV.json(), resF.json()]);

                            const getItems = (d) => Array.isArray(d) ? d : (d.data || []);

                            fetchedData = [
                                ...getItems(fetchedData),
                                ...getItems(dataL),
                                ...getItems(dataV),
                                ...getItems(dataF)
                            ];
                        } catch (e) { console.warn("Partial fetch failed", e); }
                    }
                } else if (cat === 'dubindo') {
                    const res = await fetch(`${API}/dramabox/dubindo?classify=terpopuler&page=${currentPage}`);
                    const raw = await res.json();
                    fetchedData = Array.isArray(raw) ? raw : (raw.data || []);
                } else if (cat === 'vip') {
                    const res = await fetch(`${API}/dramabox/vip${append ? `?page=${currentPage}` : ''}`);
                    const raw = await res.json();
                    fetchedData = Array.isArray(raw) ? raw : (raw.data || []);
                    if (!fetchedData || fetchedData.length === 0) {
                        const fall = await fetch(`${API}/dramabox/foryou?page=${currentPage}`);
                        const rawF = await fall.json();
                        fetchedData = Array.isArray(rawF) ? rawF : (rawF.data || []);
                    }
                }

                // Global Fallback if absolutely nothing found
                if ((!fetchedData || fetchedData.length === 0) && !append) {
                    const fallback = await fetch(`${API}/dramabox/foryou?page=1`);
                    const fallRaw = await fallback.json();
                    fetchedData = Array.isArray(fallRaw) ? fallRaw : (fallRaw.data || []);
                }

                if (fetchedData && Array.isArray(fetchedData) && fetchedData.length > 0) {
                    const newItems = fetchedData.filter(i => i && (getSafeId(i)));
                    if (!append) {
                        allDramas = [];
                        grid.innerHTML = ''; // Clear for fresh load
                        grid.classList.add('animate-fade');
                        setTimeout(() => grid.classList.remove('animate-fade'), 600);
                    }

                    newItems.forEach(item => {
                        const id = getSafeId(item);
                        if (!allDramas.some(ex => getSafeId(ex) === id)) {
                            allDramas.push(item);
                            objStore.d[id] = item;
                        }
                    });

                    renderGrid(allDramas);
                    btn.style.display = allDramas.length >= 10 ? 'block' : 'none';
                } else {
                    if (!append) grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 50px; opacity: 0.6;">
                            <i class="fas fa-magic fa-3x" style="margin-bottom:20px; color:var(--primary);"></i><br>
                            <b>Koleksi sedang diperbarui secara otomatis.</b><br>
                            Silakan coba kategori lain atau klik "Muat Ulang" di bawah ini.
                            <br><br>
                            <button class="btn-glow" onclick="loadContent('${cat}')">Muat Ulang Koleksi</button>
                        </div>`;
                    btn.style.display = 'none';
                }
            } catch (e) {
                console.error(e);
                if (!append) grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 50px;">Gagal memuat API Drama.<br><button class="btn-glow" onclick="loadContent(\'' + currentCat + '\')" style="margin-top:20px;">Coba Lagi</button></div>';
                btn.style.display = 'none';
            }
        }

        function loadMore() {
            const btn = document.getElementById('loadMoreBtn');
            const oldHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Menemukan Drama Baru...';
            btn.disabled = true;

            setTimeout(() => {
                loadContent(currentCat, null, true).finally(() => {
                    btn.innerHTML = oldHtml;
                    btn.disabled = false;
                });
            }, 600);
        }

        function renderGrid(data, customEmpty = null) {
            const grid = document.getElementById('dramaGrid');
            if (!data || data.length === 0) {
                grid.innerHTML = customEmpty || `
                    <div style="grid-column: 1/-1; text-align: center; padding: 50px; opacity: 0.6;">
                        <i class="fas fa-box-open fa-3x" style="margin-bottom:20px;"></i><br>
                        Koleksi sedang diperbarui, silakan coba kategori lain.
                    </div>`;
                return;
            }

            grid.innerHTML = data.map(d => {
                const id = getSafeId(d);
                objStore.d[id] = d;
                const active = wl.some(w => getSafeId(w) === id);
                const title = d.bookName || d.dramaName || d.title || 'Drama Premium';
                const cov = d.coverWap || d.cover || d.img || 'https://via.placeholder.com/200x300/1a1a1a/ffffff?text=FirzDrama';

                return `<div class="drama-card animate-slide" onclick="openDById('${id}')">
                    <div class="img-container">
                        <img src="${cov}" loading="lazy" alt="${title}">
                        <div class="card-badge">${d.chapterCount || d.totalChapter || d.episodeCount || '??'} EPS</div>
                        <button class="wl-toggle ${active ? 'active' : ''}" onclick="event.stopPropagation(); toggleWatchlistById('${id}')">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                    <div class="card-info">
                        <h3>${title}</h3>
                        <p>${d.tags && d.tags.length ? d.tags[0] : (d.category || 'Cinematic Series')}</p>
                    </div>
                </div>`;
            }).join('');
        }

        function openDById(id) { const d = objStore.d[id]; if (d) openD(d); }

        async function openD(d) {
            showSection('detail');
            const dramaTitle = d.bookName || d.dramaName || d.title || 'Loading...';
            document.getElementById('detTitle').innerText = dramaTitle;
            document.getElementById('detDesc').innerText = d.introduction || d.desc || 'Drama eksklusif tanpa deskripsi.';
            const eg = document.getElementById('epGrid');
            eg.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; opacity:0.5;"><i class="fas fa-spinner fa-spin"></i> Memuat Episode...</div>';

            const bId = getSafeId(d);
            renderDetailActions(d);

            async function fetchEps(id) {
                try {
                    const res = await fetch(`${API}/dramabox/allepisode?bookId=${id}`);
                    const result = await res.json();
                    return Array.isArray(result) ? result : (result.data || []);
                } catch (e) { return []; }
            }

            try {
                let eps = await fetchEps(bId);

                // Tier 2 Recovery: Try alternatives if empty
                if (!eps || eps.length === 0) {
                    const altId = d.id || d.bookID;
                    if (altId && altId !== bId) eps = await fetchEps(altId);
                }

                // Tier 3 Recovery: Search through allDramas for matching titles if IDs are totally broken
                if (!eps || eps.length === 0) {
                    const match = allDramas.find(item => (item.bookName || item.title || item.dramaName) === (d.bookName || d.title || d.dramaName));
                    if (match && getSafeId(match) !== bId) eps = await fetchEps(getSafeId(match));
                }

                const epLen = eps.length;
                document.getElementById('epCount').innerText = `${epLen} Episodes`;

                if (epLen > 0) {
                    d.episodes = eps; // Store for batch download
                    eg.innerHTML = eps.map((e, i) => {
                        const eid = `e_${bId}_${i}`;
                        objStore.e[eid] = e;
                        return `
                            <button class="ep-btn" id="ep-${i}" onclick="playVidById('${eid}', '${bId}', ${i})">
                                ${e.episodeNumber || (i + 1)}
                            </button>
                        `;
                    }).join('');
                    playVid(eps[0], d, 0);
                    renderDetailActions(d); // Refresh to show download button
                } else {
                    eg.innerHTML = `
                        <div style="grid-column:1/-1; text-align:center; padding:20px; opacity:0.7;">
                            <i class="fas fa-exclamation-circle fa-2x" style="margin-bottom:10px; color:var(--secondary);"></i><br>
                            Koleksi episode sedang disiapkan.<br>
                            <button class="tab-btn" style="margin-top:10px; width:auto; display:inline-flex;" onclick="openDById('${bId}')">
                                <i class="fas fa-sync"></i> Paksa Muat Ulang
                            </button>
                        </div>`;
                }
            } catch (e) {
                console.error("Fetch EP error:", e);
                eg.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:var(--danger);">Gagal memuat link server. Silakan coba drama lain.</div>';
            }
        }

        function playVidById(eid, did, idx) {
            const ep = objStore.e[eid];
            const d = objStore.d[did];
            if (ep && d) playVid(ep, d, idx);
        }

        function renderDetailActions(d) {
            const acts = document.getElementById('detActions');
            if (!acts) return;
            const id = getSafeId(d);
            const inWl = wl.some(w => getSafeId(w) === id);
            const hasEps = d.episodes && d.episodes.length > 0;

            acts.innerHTML = `
                <button class="btn-glow" style="background:${inWl ? 'var(--glass)' : ''}; border:${inWl ? '1px solid var(--border)' : ''};" onclick="toggleWatchlistById('${id}')">
                    <i class="fas ${inWl ? 'fa-minus' : 'fa-plus'}"></i> ${inWl ? 'Dihapus' : 'Playlist'}
                </button>
                ${hasEps ? `
                <button class="tab-btn" style="background:rgba(16, 185, 129, 0.1); color:var(--success); border-color:var(--success);" onclick="openDownloadOptions('${id}')">
                    <i class="fas fa-download"></i> Download
                </button>` : ''}
                <button class="tab-btn" onclick="shareDrama('${id}')" style="min-width:44px;">
                    <i class="fas fa-share-alt"></i>
                </button>
            `;
        }

        let currentDlDrama = null;
        let currentDlEpIdx = 0;

        function openDownloadOptions(id) {
            currentDlDrama = objStore.d[id];
            if (!currentDlDrama || !currentDlDrama.episodes) return showToast('Harap tunggu episode dimuat.', 'error');

            const activeEpBtn = document.querySelector('.ep-btn.active');
            currentDlEpIdx = activeEpBtn ? parseInt(activeEpBtn.id.split('-')[1]) : 0;

            document.getElementById('dlModalTitle').innerText = currentDlDrama.bookName || currentDlDrama.title;

            document.getElementById('dlCurrentBtn').onclick = () => {
                const ep = currentDlDrama.episodes[currentDlEpIdx];
                triggerDirectDownload(ep, currentDlEpIdx + 1);
                closeDownloadModal();
            };

            document.getElementById('dlAllBtn').onclick = () => {
                showToast('Mulai mengunduh semua episode...');
                currentDlDrama.episodes.forEach((e, i) => {
                    setTimeout(() => triggerDirectDownload(e, i + 1), i * 1500);
                });
                closeDownloadModal();
            };

            document.getElementById('downloadModal').classList.add('active');
        }

        function closeDownloadModal() { document.getElementById('downloadModal').classList.remove('active'); }

        function triggerDirectDownload(ep, num) {
            const url = ep.streamUrl || ep.videoUrl || ep.url || (ep.cdnList && ep.cdnList[0]?.videoPathList[0]?.videoPath) || '';
            if (!url) return showToast(`Gagal mendapatkan link Episode ${num}`, 'error');

            const a = document.createElement('a');
            a.href = url;
            a.target = '_blank';
            a.download = `FirzDrama_EP${num}_${(currentDlDrama.bookName || 'Drama').replace(/\s/g, '_')}.mp4`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function shareDrama(id) {
            const d = objStore.d[id];
            const title = d.bookName || d.dramaName || d.title;
            const text = `Nonton drama seru "${title}" gratis di FirzDrama!`;
            if (navigator.share) {
                navigator.share({ title: 'FirzDrama', text: text, url: window.location.href });
            } else {
                showToast('Link disalin ke clipboard!');
            }
        }

        function playVid(ep, d, idx) {
            const v = document.getElementById('mainVideo');
            let url = '';

            // High-compatibility URL extraction across all API versions
            if (ep.streamUrl) url = ep.streamUrl;
            else if (ep.videoUrl) url = ep.videoUrl;
            else if (ep.cdnList && ep.cdnList[0] && ep.cdnList[0].videoPathList && ep.cdnList[0].videoPathList[0]) {
                url = ep.cdnList[0].videoPathList[0].videoPath;
            } else if (ep.videoPath) url = ep.videoPath;
            else if (ep.m3u8Url) url = ep.m3u8Url;
            else if (ep.url) url = ep.url;
            // Last resort: check any string key for .m3u8
            if (!url) {
                for (let key in ep) {
                    if (typeof ep[key] === 'string' && (ep[key].includes('.m3u8') || ep[key].includes('.mp4'))) {
                        url = ep[key]; break;
                    }
                }
            }

            // Update UI
            document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active'));
            const activeBtn = document.getElementById(`ep-${idx}`);
            if (activeBtn) activeBtn.classList.add('active');

            // Save History (Server Synced)
            const bId = getSafeId(d);
            if (!hist.some(h => getSafeId(h) === bId)) {
                hist.unshift({ ...d, t: Date.now() });
                if (hist.length > 20) hist.pop();
                syncPersonalData();
            }

            if (hlsObj) hlsObj.destroy();

            if (url && (url.includes('.m3u8') || url.includes('index'))) {
                if (Hls.isSupported()) {
                    hlsObj = new Hls();
                    hlsObj.loadSource(url);
                    hlsObj.attachMedia(v);
                    hlsObj.on(Hls.Events.MANIFEST_PARSED, () => v.play());
                    hlsObj.on(Hls.Events.ERROR, (event, data) => {
                        if (data.fatal) {
                            console.warn("HLS Fatal error, trying direct source", data);
                            v.src = url; v.play();
                        }
                    });
                } else {
                    v.src = url; v.play();
                }
            } else if (url) {
                v.src = url;
                v.play();
            } else {
                showToast('Video URL tidak ditemukan!', 'error');
            }
        }

        // Global Search Debounce
        let searchTimeout = null;
        const searchInput = document.getElementById('searchInput');

        searchInput.oninput = (e) => {
            const val = e.target.value.trim();
            clearTimeout(searchTimeout);

            if (!val) {
                // If search is cleared, go back to the current active category
                loadContent(currentCat, null);
                return;
            }

            // Debounce: Wait 500ms before calling API
            searchTimeout = setTimeout(async () => {
                const grid = document.getElementById('dramaGrid');
                const btn = document.getElementById('loadMoreBtn');

                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 50px;"><i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>Mencari "' + val + '" di Database...</div>';
                btn.style.display = 'none';

                try {
                    const res = await fetch(`${API}/dramabox/search?query=${encodeURIComponent(val)}`);
                    const data = await res.json();

                    logActivity(`Mencari drama: "${val}"`);

                    // Filter out non-book items if they exist (sometimes API returns actors or other types)
                    const results = data.filter(i => i.bookId);

                    if (results.length > 0) {
                        allDramas = results;
                        renderGrid(results);
                    } else {
                        grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 50px; opacity: 0.6;">
                            <i class="fas fa-search-minus fa-3x"></i><br><br>
                            Drama "${val}" tidak ditemukan.<br>Coba kata kunci lain (contoh: "Pewaris", "Cinta", "Boss").
                        </div>`;
                    }
                } catch (e) {
                    grid.innerHTML = 'Gagal melakukan pencarian.';
                }
            }, 500);
        };

        // Profile
        function renderProfileData() {
            document.getElementById('profLabelName').innerText = current.name;
            document.getElementById('profLabelRole').innerText = current.role.toUpperCase();
            document.getElementById('editFullname').value = current.name;
            const hl = document.getElementById('historyList');
            hl.innerHTML = hist.length === 0 ?
                '<div style="text-align:center; padding:30px; opacity:0.5;"><i class="fas fa-film fa-2x mb-2"></i><br>Belum ada riwayat menonton.</div>' :
                hist.map(h => {
                    const id = getSafeId(h);
                    objStore.d[id] = h;
                    return `
                <div class="history-item" onclick="openDById('${id}')">
                    <div class="hist-thumb-wrapper">
                        <img src="${h.coverWap || h.cover}" class="hist-thumb">
                    </div>
                    <div class="hist-details">
                        <b>${h.bookName || h.dramaName || h.title}</b>
                        <small><i class="far fa-calendar-alt"></i> ${new Date(h.t).toLocaleDateString()}  <i class="far fa-clock"></i> ${new Date(h.t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>
                    </div>
                    <div class="hist-play-icon">
                        <i class="fas fa-play"></i>
                    </div>
                </div>`}).join('');
        }

        function saveProfileName() {
            const n = document.getElementById('editFullname').value;
            if (!n) return;
            showConfirm('Update Nama?', `Ubah nama menjadi ${n}?`, () => {
                current.name = n; syncProfile(); updateUI(); showToast('Nama diperbarui!');
            });
        }

        function handleUpdatePass() {
            const c = document.getElementById('curP').value, n = document.getElementById('newP').value, cf = document.getElementById('confP').value;
            if (c !== current.password) return showToast('Password lama salah!', 'error');
            if (n !== cf) return showToast('Konfirmasi tidak cocok!', 'error');
            if (n.length < 8) return showToast('Password minimal 8 karakter!', 'error');
            showConfirm('Ganti Password?', 'Anda akan diminta login ulang setelah ini.', () => {
                current.password = n; syncProfile();
                logActivity('Updated password');
                showToast('Password Diganti! Silakan login ulang.'); setTimeout(handleLogout, 1500);
            });
        }

        function uploadAvatar(input) {
            const f = input.files[0]; if (!f) return;
            const r = new FileReader(); r.onload = (e) => {
                current.avatar = e.target.result; syncProfile(); updateUI(); renderProfileData();
                logActivity('Updated profile picture');
                showToast('Foto Profil Diperbarui!');
            }; r.readAsDataURL(f);
        }

        function syncProfile() {
            const i = users.findIndex(u => u.id === current.id); users[i] = current; syncUsers();
            localStorage.setItem('firz_pro_session', JSON.stringify(current));
        }

        // Dynamic Avatar Helper
        function getAvatar(user) {
            if (!user) return 'https://ui-avatars.com/api/?name=User&background=orange&color=fff';
            if (user.avatar) return user.avatar;
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'];
            const name = user.name || user.username || 'User';
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            const color = colors[Math.abs(hash) % colors.length];
            const initial = name.charAt(0).toUpperCase();
            return `https://ui-avatars.com/api/?name=${initial}&background=${color.replace('#', '')}&color=fff&size=128&bold=true`;
        }

        function handleLogout() { localStorage.removeItem('firz_pro_session'); location.reload(); }

        // Admin
        function showAdmin(el) {
            if (el) {
                document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
            }
            showSection('admin');
            setAdminTab('dash');
            logActivity('Accessed Admin Panel');
        }

        function setAdminTab(tab, el) {
            if (el) {
                const parent = el.parentElement;
                parent.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
            }
            ['adminDash', 'adminUsers', 'adminChats'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById('admin' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');

            if (tab === 'dash') updateAdminStats();
            if (tab === 'users') renderUserTable();
            if (tab === 'chats') renderAdminChats();
        }

        function updateAdminStats() {
            document.getElementById('st_users').innerText = users.length;
            document.getElementById('st_chats').innerText = [...new Set(chats.map(c => c.uid))].length;
            document.getElementById('st_dramas').innerText = allDramas.length || '1k+';
            document.getElementById('st_active').innerText = logs.filter(l => (Date.now() - l.t) < 300000).length; // Active last 5 mins
            renderLogs();
        }

        function renderUserTable() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td><div style="display:flex; align-items:center; gap:10px;"><img src="${getAvatar(u)}" style="width:40px;height:40px;border-radius:50%; border:1px solid var(--border);">${u.name}</div></td>
                    <td>${u.username}</td>
                    <td><b>${u.role}</b></td>
                    <td><span class="status-badge status-${u.status}">${u.status}</span></td>
                    <td>
                        <button class="icon-btn" onclick="event.stopPropagation(); editUser('${u.id}')" style="display:inline-flex;margin-right:5px;"><i class="fas fa-edit"></i></button>
                        ${u.id === '1' ? '' : `<button class="icon-btn" onclick="event.stopPropagation(); toggleSoftDelete('${u.id}')" style="display:inline-flex; border-color:var(--danger); color:var(--danger);"><i class="fas fa-${u.status === 'active' ? 'trash' : 'undo'}"></i></button>`}
                    </td>
                </tr>
            `).join('');
        }

        function toggleSoftDelete(id) {
            const u = users.find(x => x.id === id);
            if (!u) return;
            const type = u.status === 'active' ? 'Nonaktifkan' : 'Aktifkan';
            showConfirm(`${type} User?`, `User ${u.name} akan di-${u.status === 'active' ? 'nonaktifkan' : 'aktifkan kembali'}.`, () => {
                u.status = u.status === 'active' ? 'deleted' : 'active';
                syncUsers();
                showAdmin();
                showToast(`User ${u.status === 'active' ? 'diaktifkan' : 'dinonaktifkan'}.`);
            });
        }

        function openAdminModal() { editUid = null; document.getElementById('admModalTitle').innerText = 'Tambah User'; document.getElementById('am_name').value = ''; document.getElementById('am_u').value = ''; document.getElementById('am_p').value = ''; document.getElementById('adminModal').classList.add('active'); }
        function closeAdminModal() { document.getElementById('adminModal').classList.remove('active'); }

        function handleSaveAdmin() {
            const n = document.getElementById('am_name').value, u = document.getElementById('am_u').value, p = document.getElementById('am_p').value, r = document.getElementById('am_r').value;
            if (!n || !u || !p) return showToast('Lengkapi data!', 'error');
            if (p.length < 8) return showToast('Password minimal 8 karakter!', 'error');
            if (editUid) {
                const i = users.findIndex(x => x.id === editUid);
                users[i] = { ...users[i], name: n, username: u, password: p, role: r };
                showToast('Detail User diperbarui!');
            } else {
                users.push({ id: Date.now().toString(), name: n, username: u, password: p, role: r, avatar: '', status: 'active' });
                showToast('User baru ditambahkan!');
            }
            syncUsers(); closeAdminModal(); renderUserTable();
        }

        function editUser(id) {
            const u = users.find(x => x.id === id); editUid = id;
            document.getElementById('admModalTitle').innerText = 'Edit User';
            document.getElementById('am_name').value = u.name; document.getElementById('am_u').value = u.username; document.getElementById('am_p').value = u.password; document.getElementById('am_r').value = u.role;
            document.getElementById('adminModal').classList.add('active');
        }

        // Helpers
        function syncUsers() {
            localStorage.setItem('firz_pro_users', JSON.stringify(users));
            serverSync('users', users);
        }

        async function serverSync(type, data) {
            try {
                await fetch(`/api/sync-${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (e) { console.warn('Server sync failed, will retry later.'); }
        }

        // Registration Logic
        function showRegister() { document.getElementById('registerModal').classList.add('active'); }
        function closeRegister() { document.getElementById('registerModal').classList.remove('active'); }

        document.getElementById('regForm').onsubmit = (e) => {
            e.preventDefault();
            const n = document.getElementById('regName').value, u = document.getElementById('regU').value, p = document.getElementById('regP').value;
            if (p.length < 8) return showToast('Password minimal 8 karakter!', 'error');
            if (users.find(x => x.username === u)) return showToast('Username sudah digunakan!', 'error');

            const newUser = { id: Date.now().toString(), name: n, username: u, password: p, role: 'admin', avatar: '', status: 'active' };
            users.push(newUser);
            syncUsers();
            closeRegister();
            current = newUser;
            localStorage.setItem('firz_pro_session', JSON.stringify(newUser));
            showApp();
            logActivity('Registered new account');
            showToast('Pendaftaran Berhasil! Login sebagai ADMIN.');
        };

        // Real-time Chat System
        function toggleChat() {
            const box = document.getElementById('chatBox');
            box.style.display = box.style.display === 'flex' ? 'none' : 'flex';
            document.getElementById('chatBadge').style.display = 'none';
        }

        function sendChat() {
            const inp = document.getElementById('chatInput');
            const val = inp.value.trim();
            if (!val) return;
            const msg = { t: Date.now(), uid: current.id, name: current.name, msg: val, side: 'sent' };
            chats.push(msg);
            inp.value = '';
            saveChats();
            renderChat();
            logActivity('Sent a message to admin');
        }

        function saveChats() {
            localStorage.setItem('firz_pro_chats', JSON.stringify(chats));
            serverSync('chats', chats);
        }

        function renderChat() {
            const body = document.getElementById('chatBody');
            if (!body || !current) return;
            // Get chats where (I am sender) OR (I am receiver)
            const myChats = chats.filter(c => c.uid === current.id || (c.side === 'received' && c.to === current.id));
            body.innerHTML = myChats.map(c => `
                <div class="msg ${c.side === 'sent' ? 'sent' : 'received'}">${c.msg}</div>
            `).join('');
            body.scrollTop = body.scrollHeight;
        }

        function renderAdminChats() {
            const list = document.getElementById('adminUserList');
            if (!list || !current) return;

            // Find all unique users who have a conversation with admin
            const convoPartners = [...new Set(chats.map(c => {
                if (c.side === 'sent') return c.uid; // User sent
                if (c.side === 'received') return c.to; // Admin sent to
                return null;
            }))].filter(id => id && id !== current.id);

            list.innerHTML = '<h3 style="margin-bottom:15px; font-size:1rem; opacity:0.6;">Daftar Percakapan</h3>' +
                (convoPartners.length === 0 ? '<p style="font-size:0.8rem; opacity:0.5;">Belum ada chat masuk.</p>' :
                    convoPartners.map(uid => {
                        const u = users.find(x => x.id === uid);
                        return `
                    <div class="chat-user-item ${activeChatUser === uid ? 'active' : ''}" onclick="openAdminChat('${uid}')">
                        <img src="${getAvatar(u || { name: '?' })}" style="width:32px;height:32px;border-radius:50%;">
                        <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                            <b>${u ? u.name : 'User ' + uid.slice(-4)}</b>
                        </div>
                    </div>
                `;
                    }).join(''));
        }

        function openAdminChat(uid) {
            activeChatUser = uid;
            document.getElementById('adminChatFooter').style.display = 'flex';
            renderAdminUserChat();
            renderAdminChats();
        }

        function renderAdminUserChat() {
            const body = document.getElementById('adminChatBody');
            if (!activeChatUser) return;
            const userChats = chats.filter(c => c.uid === activeChatUser || (c.side === 'received' && c.to === activeChatUser));
            body.innerHTML = userChats.map(c => `<div class="msg ${c.side === 'sent' ? 'received' : 'sent'}">${c.msg}</div>`).join('');
            body.scrollTop = body.scrollHeight;
        }

        function replyChat() {
            const inp = document.getElementById('adminChatIn');
            const val = inp.value.trim();
            if (!val || !activeChatUser) return;
            const msg = { t: Date.now(), uid: current.id, name: current.name, msg: val, side: 'received', to: activeChatUser };
            chats.push(msg);
            inp.value = '';
            saveChats();
            renderAdminUserChat();
        }

        async function syncRealtimeData() {
            try {
                const res = await fetch('/api/load-all');
                const cloud = await res.json();

                // Sync Chats
                if (cloud.chats && cloud.chats.length > chats.length) {
                    chats = cloud.chats;
                    if (current) renderChat();
                    if (current && current.role === 'admin') renderAdminChats();
                    if (activeChatUser) renderAdminUserChat();
                    if (document.getElementById('chatBox').style.display !== 'flex') document.getElementById('chatBadge').style.display = 'block';
                    localStorage.setItem('firz_pro_chats', JSON.stringify(chats));
                }

                // Sync Users
                if (cloud.users && JSON.stringify(cloud.users) !== JSON.stringify(users)) {
                    users = cloud.users;
                    if (current && current.role === 'admin') renderUserTable();
                    localStorage.setItem('firz_pro_users', JSON.stringify(users));
                }

                // Sync Logs
                if (cloud.logs && cloud.logs.length !== logs.length) {
                    logs = cloud.logs;
                    renderLogs();
                    if (current && current.role === 'admin') updateAdminStats();
                    localStorage.setItem('firz_pro_logs', JSON.stringify(logs));
                }

                // Sync Playlists/History for 2-device support (ONLY if logged in)
                if (current && current.id) {
                    if (cloud.playlists && JSON.stringify(cloud.playlists[current.id]) !== JSON.stringify(wl)) {
                        playlists_db = cloud.playlists;
                        wl = playlists_db[current.id] || [];
                        // Register to objStore
                        wl.forEach(d => { objStore.d[getSafeId(d)] = d; });
                        const btn = document.querySelector('.tab-btn.active');
                        if (btn && btn.innerText.includes('Playlist')) renderGrid(wl);
                    }
                    if (cloud.history && JSON.stringify(cloud.history[current.id]) !== JSON.stringify(hist)) {
                        history_db = cloud.history;
                        hist = history_db[current.id] || [];
                        // Register to objStore
                        hist.forEach(h => { objStore.d[getSafeId(h)] = h; });
                        if (document.getElementById('profileSection').classList.contains('hidden') === false) renderProfileData();
                    }
                }
            } catch (e) {
                console.warn("Realtime sync failed", e);
            }
        }

        function showConfirm(title, msg, onYes) {
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMsg').innerText = msg;
            const btn = document.getElementById('btnYes');
            btn.onclick = () => { onYes(); closeConfirmModal(); };
            document.getElementById('confirmModal').classList.add('active');
        }
        function closeConfirmModal() { document.getElementById('confirmModal').classList.remove('active'); }

        function toggleWatchlistById(id) {
            const d = objStore.d[id];
            if (d) toggleWatchlist(d);
        }

        function toggleWatchlist(d) {
            const id = getSafeId(d);
            const idx = wl.findIndex(w => getSafeId(w) === id);
            if (idx > -1) { wl.splice(idx, 1); showToast('Dihapus dari Playlist.'); }
            else { wl.push(d); showToast('Ditambahkan ke Playlist.'); }
            syncPersonalData();

            // Update UI in Detail section if open
            const det = document.getElementById('detailSection');
            if (!det.classList.contains('hidden')) {
                renderDetailActions(d);
            }

            const btn = document.querySelector('.tab-btn.active');
            if (btn && btn.innerText.includes('Playlist')) showWatchlist(btn);
            else {
                // Just update UI card locally
                const cards = document.querySelectorAll('.drama-card');
                cards.forEach(c => {
                    if (c.innerHTML.includes(`toggleWatchlistById('${id}')`)) {
                        c.querySelector('.wl-toggle').classList.toggle('active');
                    }
                });
            }
        }

        function toggleMobileSearch() {
            document.querySelector('.search-container').classList.toggle('active');
        }

        function showWatchlist(el) {
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('homeTitle').innerHTML = `<span></span> Playlist Saya`;
            showSection('home');

            const emptyMsg = `
                <div style="grid-column: 1/-1; text-align: center; padding: 50px; opacity: 0.6;">
                    <i class="fas fa-heart-broken fa-3x" style="margin-bottom:20px; color:var(--secondary);"></i><br>
                    <b>Playlist kamu masih kosong.</b><br>
                    Klik icon <i class="fas fa-heart"></i> pada drama untuk menambahkannya ke sini.
                </div>`;
            renderGrid(wl, emptyMsg);
            document.getElementById('loadMoreBtn').style.display = 'none';
        }

        init();
    </script>
</body>

</html>